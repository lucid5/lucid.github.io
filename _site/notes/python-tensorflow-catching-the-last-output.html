<script type="text/javascript" async src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"> </script> <!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Catching the last output of RNN while training in batches</title><meta name="twitter:card" content="summary" /><meta name="twitter:site" content="@" /><meta name="twitter:title" content="Catching the last output of RNN while training in batches" /><meta name="twitter:description" content="Intro"><meta name="description" content="Intro"><meta name="google-site-verification" content="epFgX0s_0RM3CdjwFcsewfXzPov2g8s9ZBOLyaIUH-o"><link rel="icon" href="/assets/favicon.png"><link rel="apple-touch-icon" href="/assets/touch-icon.png"><link rel="stylesheet" href="//code.cdn.mozilla.net/fonts/fira.css"><link rel="stylesheet" href="/assets/core.css"><link rel="canonical" href="/notes/python-tensorflow-catching-the-last-output"><link rel="alternate" type="application/atom+xml" title="thtrieu" href="/feed.xml" /></head><body><aside class="logo"> <a href="/"> <img src="http://i.imgur.com/tU08Pu4.gif" id = "logo" onmouseover = "thatLogo()" onmouseout = "thisLogo()" onmouseup = "clicked()" class= "gravatar"> </a></aside><main> <noscript><style> article .footnotes { display: block; }</style></noscript><article><div class="center"><h1 onmouseover="buttonLogo()" onmouseout = "thisLogo()"><a href="&#109;&#097;&#105;&#108;&#116;&#111;:&#116;&#104;&#116;&#114;&#105;&#101;&#117;&#064;&#097;&#112;&#099;&#115;&#046;&#118;&#110;" target = "_blank"><img src="http://i.imgur.com/CKLpgcs.png (email icon with padding)" alt="alt text" /></a>     <a href="http://github.com/thtrieu/" target = "_blank"><img src="http://i.imgur.com/aV59QS6.png (github icon with padding)" alt="alt text" /></a>     <a href="https://linkedin.com/in/trinhhtrieu" target = "_blank"><img src="http://i.imgur.com/Q9Dr6XJ.png (linkedin icon with padding)" alt="alt text" /></a>     <a href="http://thtrieu.github.io/resume.pdf" target = "_blank"><img src="http://i.imgur.com/2amdaUm.png (resume icon with padding)" alt="alt text" /></a>     <a href="#share"><img src="http://i.imgur.com/GE4GmC3.png (share icon with padding)" alt="alt text" /></a></h1><time>February 15, 2016 - just another day in heaven</time></div><!--<div class="divider"></div>--><p>&nbsp;</p><p></p><h3 id="intro">Intro</h3><p>So I’ve been working on this project of sentence classification for a while. The baseline is this <a href="https://arxiv.org/abs/1408.5882">very-simple-yet-effective CNN from Yoon Kim</a>. It’s been a while since the model was proposed and several other models have beaten this one on several datasets. But here I’ll just work on this baseline with another focus - not beating the accuracy, but to see if injecting <em>more</em> temporal information into the structure is of any good. The reason is: sentences are sequential words, but CNN kinda produces a <em>bag of patches</em> to the next, typically, fully-connected discriminative layer. Even though patches of words contain some kind of sequential information, <em>a bag</em> is essentially the opposite. The work so far is fine. Until I encounter this problem of varying sentence length.</p><h3 id="problems-with-padding">Problems with padding</h3><p>One thing people commonly do with sentences is to pad them, as a preprossing step of their deep learning application, so that all sentences in a dataset are of the same length. The reason for this is: <code class="highlighter-rouge">Tensorflow</code> works with tensors only, apparently. And tensors essentially contains constant sized matrices or vectors, thus padding is unavoidable.</p><p>But say, sentences after being padded are passed into the structure. Then the padded part will be transformed and pushed through several layers of the network. There is a high chance that this padding information will mess with the actual content of the input at later layers and thus, create quite a bit of noise in the network’s output. Even if the padded part are all zeros, when going through a linear transformation, they will be added by some bias weight and becomes visible in contributing to the activations. So, eliminating these noise is desirable.</p><p>The dataset that I am working on have the ratio of the average sentence length to the maximum one being \( 1/4 \). So padding is injecting one hell of noise into the network. This, must be taken into account seriously.</p><h3 id="getting-the-last-output-signal-of-rnn">Getting the last output signal of RNN</h3><p>If you had a look on this <a href="http://karpathy.github.io/2015/05/21/rnn-effectiveness/">awesome blog post</a> on RNN, you’ll know that there is essentially two different uses of RNN when the input is a sequence. The first one is sequence-to-sequence, the second one is sequence-to-unit. The implementation of the first one looks something like this</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">outputs</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">rnn</span><span class="o">.</span><span class="n">rnn</span><span class="p">(</span><span class="n">lstm_cell</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">initial_state</span> <span class="o">=</span> <span class="n">initial_state</span><span class="p">)</span>
</code></pre></div></div><p>While in the second one:</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">outputs</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">rnn</span><span class="o">.</span><span class="n">rnn</span><span class="p">(</span><span class="n">lstm_cell</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">initial_state</span> <span class="o">=</span> <span class="n">initial_state</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div></div><p>Not much of a difference huh? Yes, but in the second one, getting the last output signal is something very undesirable as indicated earlier. In order to come to this final element of the list <code class="highlighter-rouge">outputs</code>, the real content have to survive a considerable amount of paddings.</p><h3 id="the-solution">The solution</h3><p>This should easily be the solution.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">output</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
    <span class="c1"># l_i : length of sentence number \\( i \\) in the batch
</span>    <span class="n">l_i</span> <span class="o">=</span> <span class="n">sentence_length</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="n">l_i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">,:]</span>
</code></pre></div></div><p>The problem is right there at <code class="highlighter-rouge">range(0, batch_size)</code>. You suppose to know the actual value of <code class="highlighter-rouge">batch_size</code> at construction phase of the graph. Can we do it? Well definitely, why in the world we cannot at all? The thing is, if you set <code class="highlighter-rouge">batch_size</code> to a specific defined number while building this graph, then how would it allow the validation/test data (which will not comes in batches) to flow in later on? Actually this can be solved in many different ways (you can easily think of one right now), and at the end of the day it actually boils down to coding style. <a href="http://thtrieu.github.io/2016/03/07/python-tensorflow-deep-learning-application-templates">This post</a> discusses the topic in much greater length. Right now, let’s assume we insist on not specifying a defined value for <code class="highlighter-rouge">batch_size</code> at construction phase.</p><p>So, if <code class="highlighter-rouge">batch_size</code>, instead of being a defined number, presents as a placeholder, how would we iterate over <code class="highlighter-rouge">range(0, batch_size)</code> and collect outputs at appropriate positions like above? Well, LSTM is theoretically a great subtitute solution thanks to its ability to ‘forget’ the unnecessary padding at the end of each sentences. And even if not using it, one can simply reverse the input so that the padding comes first and then (likely) be washed away as information propagates through several time steps.</p><p>But what if the padding creates a too noisy signal that it must be eliminated completely like in the solution above. Or what if we are the die-hard perfectionists willing to spend days and months cleansing the hell out of this noise or else we will not be able to go on with life?</p><p>Don’t worry! I’ve got here a cool and fun solution ;)</p><h3 id="defining-the-problem">Defining the problem</h3><p>So here is the problem statement:</p><p><strong>Given</strong></p><ol><li><code class="highlighter-rouge">outputs</code>, a list of length <code class="highlighter-rouge">padded_sentence_length</code>, each element being a tensor of size <code class="highlighter-rouge">batch_size</code> \( \times \) <code class="highlighter-rouge">hidden_size</code>.</li><li><code class="highlighter-rouge">sentence_length</code>, a vector of length <code class="highlighter-rouge">batch_size</code>, with entry number \( i \) being the real length of sentence number \( i \) in the batch.</li></ol><p><strong>Question</strong>: how to calculate the tensor <code class="highlighter-rouge">output</code> of size <code class="highlighter-rouge">batch_size</code> \( \times \) <code class="highlighter-rouge">hidden_size</code> with the same value produced as in the solution code, without explicitly refering to <code class="highlighter-rouge">batch_size</code>’s value?</p><p>In other words, we are trying to come up with an equivalent piece of code, with much more stingy restrictions. (Excited yet?)</p><h3 id="the-walk-around-solution">The walk-around Solution</h3><p>Before moving on to the solution, I will give here a toy example for illustration purpose</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Assume hidden_size = 2, batch_size = 3, padded_sentence_length = 4
# And the given data is:
</span><span class="n">outputs</span> <span class="o">=</span> 
<span class="p">[[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>   <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>    <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>    <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>    
  <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>     <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>     <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
  <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]];</span>   <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]];</span>    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]];</span>    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]]</span>
<span class="n">sentence_length</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="c1"># Then the expected return is
</span><span class="n">output</span> <span class="o">=</span>
<span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
 <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
 <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]]</span>
</code></pre></div></div><p>As in the restriction, you can’t iterate over <code class="highlighter-rouge">batch_size</code>, so let’s iterate over <code class="highlighter-rouge">padded_sentence_length</code> (this is pure trial and error reasoning). By this loop, we essentially go through each and every element of the list <code class="highlighter-rouge">outputs</code>. Note that each of these elements is of the same size with <code class="highlighter-rouge">output</code>, so a reasonable idea is to initialise <code class="highlighter-rouge">output</code> randomly and refine its value as we iterate through the loop using values of each <code class="highlighter-rouge">outputs[i]</code></p><p>Specifically the main idea is, as we iterate through each element of <code class="highlighter-rouge">outputs</code>, imagine <code class="highlighter-rouge">output</code> being a filter, it receives the whole value of each element but only keeps what it needs, discards the rest and then moves on.</p><p>If you follow the reasoning, at this point it is very clear that during this loop, step number \( i \) is exactly when we must set the value for <strong>all rows of <code class="highlighter-rouge">output</code></strong> that correspond the <strong>sentences with length \( i \)</strong> to the value of <strong>the same rows</strong> of <strong><code class="highlighter-rouge">outputs[i]</code></strong>. Well I admit I’ve just said something lengthy and confusing, so feel free to skip and just look at the example below to understand. Here we iterate by <code class="highlighter-rouge">i in range(0, 4)</code></p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Progression of output as we go through each iteration:
</span><span class="n">time</span>  <span class="o">|</span><span class="n">initial</span> <span class="o">|</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>  <span class="o">|</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>  <span class="o">|</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span>  <span class="o">|</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">3</span>
<span class="o">------+--------+--------+--------+--------+--------</span>
      <span class="o">|</span><span class="p">[[</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">],</span><span class="o">|</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span><span class="o">|</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span><span class="o">|</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span><span class="o">|</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
<span class="n">output</span><span class="o">|</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">],</span><span class="o">|</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span><span class="o">|</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span><span class="o">|</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span><span class="o">|</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
      <span class="o">|</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">]]</span><span class="o">|</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span><span class="o">|</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]]</span><span class="o">|</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]]</span><span class="o">|</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]]</span>
<span class="c1"># By 'x', I mean 'anything, random'.
</span></code></pre></div></div><p>How do we do that? The first thing to realise is that at each interation, the current <code class="highlighter-rouge">output</code> has some rows that should be unchanged, and some others to be updated from <code class="highlighter-rouge">outputs[i]</code>. We can do this by a matrix <code class="highlighter-rouge">mask</code> having the same size as <code class="highlighter-rouge">output</code> with entries being \( 1 \) where <code class="highlighter-rouge">output</code> should be kept and \( 0 \) otherwise.</p><p>Filtery speaking, entries with value of \( 1 \) indicates that this position on the filter <code class="highlighter-rouge">output</code> is occupied by a number that didn’t make it through the filter at some previous step, and thus this position can no longer be occupied by anything else that comes later.</p><p>Again, let’s look at the value of <code class="highlighter-rouge">mask</code> in the example</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Progression of the mask as we go through each iteration:
</span><span class="n">i</span>   <span class="o">|</span>    <span class="mi">0</span>   <span class="o">|</span>    <span class="mi">1</span>   <span class="o">|</span>    <span class="mi">2</span>   <span class="o">|</span>    <span class="mi">3</span>
<span class="o">----+--------+--------+--------+--------</span>
    <span class="o">|</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span><span class="o">|</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span><span class="o">|</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span><span class="o">|</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
<span class="n">mask</span><span class="o">|</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span><span class="o">|</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span><span class="o">|</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span><span class="o">|</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="o">|</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span><span class="o">|</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span><span class="o">|</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span><span class="o">|</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
</code></pre></div></div><p>If we are able to calculate <code class="highlighter-rouge">mask</code> at each step, then the update rule for <code class="highlighter-rouge">output</code> is simply</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">output</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">mask</span><span class="p">)</span>
</code></pre></div></div><p>So the remaining problem is to calculate <code class="highlighter-rouge">mask</code>. Looking at <code class="highlighter-rouge">mask</code>, we realise that all entries on the same row have the same value, thus <code class="highlighter-rouge">mask</code>’s value can be inferred from a single vector <code class="highlighter-rouge">v</code> that has the progression as follows:</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Progression of v as we go through each iteration:
</span><span class="n">i</span> <span class="o">|</span>  <span class="mi">0</span>  <span class="o">|</span>  <span class="mi">1</span>  <span class="o">|</span>  <span class="mi">2</span>  <span class="o">|</span>  <span class="mi">3</span>
<span class="o">--+-----+-----+-----+------</span>
  <span class="o">|</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">|</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">|</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">|</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span>
<span class="n">v</span> <span class="o">|</span>  <span class="mi">0</span><span class="p">,</span> <span class="o">|</span>  <span class="mi">0</span><span class="p">,</span> <span class="o">|</span>  <span class="mi">0</span><span class="p">,</span> <span class="o">|</span>  <span class="mi">1</span><span class="p">,</span>
  <span class="o">|</span>  <span class="mi">0</span><span class="p">]</span> <span class="o">|</span>  <span class="mi">0</span><span class="p">]</span> <span class="o">|</span>  <span class="mi">1</span><span class="p">]</span> <span class="o">|</span>  <span class="mi">1</span><span class="p">]</span>
</code></pre></div></div><p>See any patterns? Clearly the value of <code class="highlighter-rouge">v</code> must relies on the value of <code class="highlighter-rouge">i</code> (obviously, since <code class="highlighter-rouge">v</code> changes as <code class="highlighter-rouge">i</code> goes from 0 to 3), and the value of the constant <code class="highlighter-rouge">sentence_length</code>. Let’s put these three together:</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">l</span> <span class="o">=</span> <span class="n">sentence_length</span>
<span class="c1"># Progression of v as we go through each iteration:
</span><span class="n">i</span>     <span class="o">|</span>  <span class="mi">0</span>      <span class="o">|</span>  <span class="mi">1</span>      <span class="o">|</span>  <span class="mi">2</span>      <span class="o">|</span>  <span class="mi">3</span>
<span class="o">------+---------+---------+---------+--------</span>
      <span class="o">|</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">|</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">|</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">|</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span>
<span class="n">v</span> <span class="p">;</span> <span class="n">l</span> <span class="o">|</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span> <span class="o">|</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span> <span class="o">|</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span> <span class="o">|</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>
      <span class="o">|</span>  <span class="mi">0</span><span class="p">];</span> <span class="mi">2</span><span class="p">]</span> <span class="o">|</span>  <span class="mi">0</span><span class="p">];</span> <span class="mi">2</span><span class="p">]</span> <span class="o">|</span>  <span class="mi">1</span><span class="p">];</span> <span class="mi">2</span><span class="p">]</span> <span class="o">|</span>  <span class="mi">1</span><span class="p">];</span> <span class="mi">2</span><span class="p">]</span>
</code></pre></div></div><p>See the pattern now? Yes, it is indeed <code class="highlighter-rouge">v = l &lt; (i+1)</code>. And we are done (Pheeewww), here is the walk-around solution:</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">l</span> <span class="o">=</span> <span class="n">sentence_length</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">one</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="n">hidden_size</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="c1"># v * one = mask
</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">)):</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">l</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">one</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">+=</span> <span class="n">tf</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">mask</span><span class="p">)</span>
</code></pre></div></div><p>There you have it!</p><h1 id="update-28th-aug">Update 28th Aug</h1><p>There is <a href="https://gist.github.com/rockt/f4f9df5674f3da6a32786bcf9fbb6a88">this</a> much simpler way to do exactly the same thing</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">gather_by_lengths</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">seq_lengths</span><span class="p">):</span>
    <span class="s">"""
    :param outputs: [batch_size x max_seq_length x hidden_size] tensor of dynamic_rnn outputs
    :param seq_lengths: [batch_size] tensor of sequence lengths
    :return: [batch_size x hidden_size] tensor of last outputs
    """</span>
    <span class="n">batch_size</span><span class="p">,</span> <span class="n">max_seq_length</span><span class="p">,</span> <span class="n">hidden_size</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">outputs</span><span class="p">))</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span> <span class="o">*</span> <span class="n">max_seq_length</span> <span class="o">+</span> <span class="p">(</span><span class="n">seq_lengths</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">]),</span> <span class="n">index</span><span class="p">)</span>
</code></pre></div></div><p>&nbsp;</p><p></p><div class = "divider"></div><div class = "center-foot"><h1 id = "share"><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://thtrieu.github.io/notes/python-tensorflow-catching-the-last-output" target = "_blank"><img src="http://i.imgur.com/Q9Dr6XJ.png (linkedin icon with padding)" alt="alt text" /></a>     <a href="https://twitter.com/intent/tweet/?text=Catching the last output of RNN while training in batches&url=https://thtrieu.github.io/notes/python-tensorflow-catching-the-last-output" target = "_blank"><img src="http://i.imgur.com/phnE5v0.png (twitter icon with padding)" alt="alt text" /></a>     <a href="https://plus.google.com/share?url=https://thtrieu.github.io/notes/python-tensorflow-catching-the-last-output" target = "_blank"><img src="http://i.imgur.com/PeridnP.png (google plus icon with padding)" alt="alt text" /></a>     <a href="https://facebook.com/sharer/sharer.php?u=https://thtrieu.github.io/notes/python-tensorflow-catching-the-last-output" target = "_blank"><img src="http://i.imgur.com/GRvQu92.png (facebook icon with padding)" alt="alt text" /></a>     <a href="mailto:?subject=Catching the last output of RNN while training in batches&body=https://thtrieu.github.io/notes/python-tensorflow-catching-the-last-output"><img src="http://i.imgur.com/CKLpgcs.png (email icon with padding)" alt="alt text" /></a></h1></div><aside class="back"> <a href="/notes/project-debut-r-package-educational-data-synthesizer">&laquo; EDMsyn - an R package that synthesizes educational data</a></aside><aside class="next"> <a href="/notes/python-tensorflow-deep-learning-application-templates">Should we define batch size during graph construction? &raquo;</a></aside><p>&nbsp;</p><p></p><div id="disqus_thread"></div><script> /** * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS. * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables */ var disqus_config = function () { this.page.url = 'https://thtrieu.github.io/notes/python-tensorflow-catching-the-last-output'; this.page.identifier = 'https://thtrieu.github.io/notes/python-tensorflow-catching-the-last-output'; }; (function() { var d = document, s = d.createElement('script'); s.src = '//thtrieu.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); }) (); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></article></main></body><script> var that = 'http://i.imgur.com/tU08Pu4.gif'; var thiS = 'http://i.imgur.com/tU08Pu4.gif'; var sub = 'http://i.imgur.com/w6NOJp2.gif'; var but = 'http://i.imgur.com/w6NOJp2.gif'; function postLogo() { document.getElementById("logo").src = 'http://i.imgur.com/tU08Pu4.gif'; } function thatLogo() { document.getElementById("logo").src = that; } function thisLogo() { document.getElementById("logo").src = thiS; } function subLogo() { document.getElementById("logo").src = sub; } function buttonLogo() { document.getElementById("logo").src = but; } function postClicked() { thiS = 'http://i.imgur.com/tU08Pu4.gif'; } function clicked() { thiS = that; } </script></html>